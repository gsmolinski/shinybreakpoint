parse_data_str <- data.frame(
  stringsAsFactors = FALSE,
             line1 = c(1L,1L,1L,1L,1L,1L,1L,3L,
                       3L,3L,3L,3L,3L,3L,3L,3L,3L,4L,4L,5L,7L,7L,
                       7L,7L,7L,7L,7L,7L,8L,8L,8L,8L,9L,9L,9L,9L,
                       9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,
                       9L,9L,9L,9L,9L,9L,9L,10L,10L,10L,10L,10L,
                       10L,10L,10L,10L,10L,10L,10L,10L,10L,10L,11L,12L,
                       14L,14L,14L,14L,14L,14L,14L,14L,14L,14L,14L,
                       14L,14L,14L,14L,15L,15L,15L,15L,15L,15L,15L,15L,
                       15L,15L,16L,16L,17L,17L,18L,18L,18L,18L,18L,
                       18L,19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,
                       19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,
                       19L,19L,19L,19L,19L,19L,20L,20L,20L,20L,20L,
                       21L,21L,21L,21L,21L,22L,22L,24L,24L,24L,24L,24L,
                       24L,24L,24L,24L,24L,24L,24L,25L,25L,25L,25L,
                       25L,25L,26L,26L,27L,27L,28L,28L,28L,28L,28L,
                       28L,29L,29L,30L,30L,32L,32L,33L,33L,33L,33L,33L,
                       33L,33L,34L,34L,35L,35L,35L,35L,35L,36L,36L,
                       36L,36L,36L,36L,36L,36L,36L,36L,36L,36L,37L,37L,
                       37L,37L,37L,37L,37L,37L,37L,37L,37L,37L,37L,
                       38L,38L,38L,38L,38L,39L,39L,40L,40L,41L,41L,
                       42L,44L,44L,44L,44L,44L,44L,44L,44L,44L,44L),
              col1 = c(1L,1L,1L,8L,9L,9L,14L,1L,
                       1L,1L,5L,8L,8L,16L,17L,19L,19L,3L,3L,1L,1L,
                       1L,1L,4L,7L,7L,7L,16L,3L,3L,3L,11L,5L,5L,5L,
                       11L,12L,12L,13L,15L,15L,15L,26L,27L,27L,34L,
                       36L,42L,44L,44L,51L,53L,61L,63L,63L,65L,66L,
                       67L,5L,5L,5L,11L,12L,12L,13L,15L,15L,15L,25L,
                       26L,26L,33L,34L,3L,1L,1L,1L,1L,8L,11L,11L,19L,
                       20L,25L,27L,33L,35L,42L,44L,44L,3L,3L,3L,9L,
                       12L,12L,12L,20L,21L,21L,5L,5L,3L,4L,3L,3L,3L,
                       10L,11L,11L,5L,5L,5L,11L,12L,12L,24L,26L,26L,
                       26L,38L,39L,39L,39L,39L,50L,51L,51L,57L,58L,
                       59L,65L,67L,79L,81L,81L,83L,84L,12L,18L,20L,20L,
                       30L,5L,5L,5L,10L,11L,3L,4L,3L,3L,3L,15L,16L,
                       16L,16L,21L,22L,27L,29L,29L,5L,5L,5L,12L,13L,
                       13L,7L,7L,5L,6L,5L,5L,5L,12L,13L,13L,7L,7L,
                       5L,6L,3L,4L,3L,3L,3L,3L,11L,12L,12L,5L,5L,3L,
                       4L,6L,9L,9L,3L,3L,3L,16L,17L,17L,17L,22L,
                       23L,28L,30L,30L,5L,5L,5L,5L,11L,12L,18L,21L,21L,
                       21L,32L,33L,33L,7L,7L,7L,12L,13L,7L,7L,5L,
                       6L,3L,4L,1L,1L,1L,1L,9L,10L,10L,12L,14L,14L,
                       20L),
             line2 = c(1L,1L,1L,1L,1L,1L,1L,5L,
                       3L,3L,3L,5L,3L,3L,3L,5L,3L,4L,4L,5L,12L,7L,
                       7L,7L,12L,7L,7L,7L,11L,8L,8L,8L,9L,9L,9L,9L,
                       9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,9L,
                       9L,9L,9L,9L,9L,9L,9L,9L,10L,10L,10L,10L,10L,
                       10L,10L,10L,10L,10L,10L,10L,10L,10L,10L,11L,
                       12L,42L,14L,14L,14L,42L,14L,14L,14L,14L,14L,14L,
                       14L,14L,42L,14L,17L,15L,15L,15L,17L,15L,15L,
                       15L,17L,15L,16L,16L,17L,17L,22L,18L,18L,18L,
                       22L,18L,20L,19L,19L,19L,19L,19L,19L,19L,19L,19L,
                       19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,19L,
                       19L,19L,19L,19L,19L,19L,19L,20L,20L,20L,20L,20L,
                       21L,21L,21L,21L,21L,22L,22L,32L,24L,24L,24L,
                       24L,24L,24L,24L,24L,24L,32L,24L,27L,25L,25L,
                       25L,27L,25L,26L,26L,27L,27L,30L,28L,28L,28L,30L,
                       28L,29L,29L,30L,30L,32L,32L,35L,35L,33L,33L,
                       33L,35L,33L,34L,34L,35L,35L,35L,35L,35L,41L,36L,
                       36L,36L,36L,36L,36L,36L,36L,36L,41L,36L,40L,
                       37L,37L,37L,37L,37L,37L,40L,37L,37L,37L,40L,
                       37L,38L,38L,38L,38L,38L,39L,39L,40L,40L,41L,41L,
                       42L,44L,44L,44L,44L,44L,44L,44L,44L,44L,44L),
              col2 = c(14L,7L,7L,8L,13L,13L,14L,
                       1L,3L,3L,6L,1L,15L,16L,17L,1L,19L,5L,5L,1L,
                       1L,2L,2L,5L,1L,15L,15L,16L,3L,10L,10L,11L,66L,
                       10L,10L,11L,12L,12L,13L,65L,25L,25L,26L,33L,
                       33L,34L,40L,42L,50L,50L,51L,59L,61L,64L,64L,
                       65L,66L,67L,34L,10L,10L,11L,12L,12L,13L,33L,24L,
                       24L,25L,32L,32L,33L,34L,3L,1L,1L,6L,6L,9L,1L,
                       18L,19L,24L,25L,32L,33L,41L,42L,1L,44L,4L,7L,
                       7L,10L,4L,19L,19L,20L,3L,21L,7L,7L,3L,4L,4L,
                       9L,9L,10L,3L,11L,30L,10L,10L,11L,23L,23L,24L,
                       83L,37L,37L,38L,64L,57L,49L,49L,50L,56L,56L,
                       57L,58L,64L,65L,77L,79L,82L,82L,83L,84L,16L,
                       18L,29L,29L,30L,11L,9L,9L,10L,11L,3L,4L,4L,14L,
                       14L,15L,26L,20L,20L,21L,26L,27L,3L,29L,6L,11L,
                       11L,12L,5L,13L,9L,9L,5L,6L,6L,11L,11L,12L,
                       5L,13L,9L,9L,5L,6L,3L,4L,13L,4L,10L,10L,11L,
                       3L,12L,7L,7L,3L,4L,7L,13L,13L,4L,15L,15L,16L,
                       27L,21L,21L,22L,27L,28L,3L,30L,6L,16L,10L,10L,
                       11L,16L,19L,6L,31L,31L,32L,5L,33L,13L,11L,11L,
                       12L,13L,30L,30L,5L,6L,3L,4L,1L,20L,8L,8L,9L,
                       11L,11L,12L,19L,19L,20L),
                id = c(10L,1L,3L,2L,4L,6L,5L,
                       35L,16L,18L,17L,34L,19L,20L,21L,31L,22L,24L,26L,
                       29L,133L,40L,42L,41L,131L,43L,45L,44L,125L,47L,
                       49L,48L,90L,51L,53L,52L,54L,55L,56L,85L,60L,
                       62L,61L,63L,65L,64L,69L,70L,71L,73L,72L,77L,
                       78L,79L,81L,80L,86L,91L,119L,96L,98L,97L,99L,
                       100L,101L,114L,105L,107L,106L,108L,110L,109L,115L,
                       121L,127L,423L,138L,140L,139L,422L,141L,142L,
                       143L,144L,146L,147L,149L,150L,419L,152L,176L,154L,
                       156L,155L,174L,157L,159L,158L,169L,160L,162L,
                       164L,167L,170L,255L,179L,181L,180L,250L,182L,235L,
                       184L,186L,185L,187L,189L,188L,221L,193L,195L,
                       194L,208L,205L,196L,198L,197L,199L,201L,200L,206L,
                       207L,209L,213L,214L,215L,216L,217L,222L,227L,
                       228L,229L,231L,230L,244L,239L,241L,240L,242L,248L,
                       251L,326L,261L,263L,262L,268L,264L,266L,265L,
                       267L,269L,321L,273L,292L,275L,277L,276L,287L,278L,
                       280L,282L,285L,288L,313L,296L,298L,297L,308L,
                       299L,301L,303L,306L,309L,319L,322L,352L,347L,330L,
                       332L,331L,342L,333L,335L,337L,340L,343L,348L,
                       349L,351L,413L,355L,357L,356L,362L,358L,360L,359L,
                       361L,363L,408L,367L,403L,373L,369L,371L,370L,
                       372L,374L,401L,375L,377L,376L,396L,378L,385L,380L,
                       382L,381L,383L,389L,391L,394L,397L,406L,409L,
                       417L,443L,428L,430L,429L,431L,433L,432L,437L,439L,
                       438L),
            parent = c(0L,3L,10L,10L,6L,10L,10L,
                       0L,18L,35L,35L,35L,34L,34L,34L,34L,31L,26L,
                       31L,31L,0L,42L,133L,133L,133L,45L,131L,131L,131L,
                       49L,125L,125L,125L,53L,90L,90L,55L,90L,90L,90L,
                       62L,85L,85L,65L,85L,85L,85L,85L,73L,85L,85L,
                       85L,85L,81L,85L,85L,90L,125L,125L,98L,119L,119L,
                       100L,119L,119L,119L,107L,114L,114L,110L,114L,
                       114L,119L,125L,131L,0L,140L,423L,423L,423L,422L,
                       422L,422L,422L,422L,422L,422L,422L,422L,419L,
                       419L,156L,176L,176L,176L,159L,174L,174L,174L,169L,
                       164L,169L,169L,174L,419L,181L,255L,255L,255L,
                       250L,250L,186L,235L,235L,189L,235L,235L,235L,195L,
                       221L,221L,221L,208L,198L,205L,205L,201L,205L,
                       205L,208L,208L,221L,221L,221L,216L,221L,221L,235L,
                       235L,235L,231L,235L,235L,250L,241L,244L,244L,
                       244L,250L,255L,419L,263L,326L,326L,326L,266L,268L,
                       268L,268L,326L,326L,321L,321L,277L,292L,292L,
                       292L,287L,282L,287L,287L,292L,321L,298L,313L,313L,
                       313L,308L,303L,308L,308L,313L,321L,326L,419L,
                       352L,332L,347L,347L,347L,342L,337L,342L,342L,347L,
                       352L,351L,352L,419L,357L,413L,413L,413L,360L,
                       362L,362L,362L,413L,413L,408L,408L,403L,371L,373L,
                       373L,373L,403L,403L,377L,401L,401L,401L,396L,
                       396L,382L,385L,385L,385L,391L,396L,396L,401L,408L,
                       413L,419L,0L,430L,443L,443L,433L,443L,443L,439L,
                       443L,443L),
             token = c("expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","SYMBOL","expr","')'","expr","SYMBOL",
                       "expr","LEFT_ASSIGN","expr","FUNCTION","'('","')'",
                       "expr","'{'","STR_CONST","expr","'}'","expr",
                       "SYMBOL","expr","LEFT_ASSIGN","expr",
                       "SYMBOL_FUNCTION_CALL","expr","'('","expr","SYMBOL_FUNCTION_CALL","expr",
                       "'('","expr","SYMBOL_FUNCTION_CALL","expr","'('",
                       "NUM_CONST","expr","','","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","STR_CONST","expr","','","SYMBOL_SUB",
                       "EQ_SUB","STR_CONST","expr","','","SYMBOL_SUB",
                       "EQ_SUB","STR_CONST","expr","')'","')'","','","expr",
                       "SYMBOL_FUNCTION_CALL","expr","'('","NUM_CONST",
                       "expr","','","expr","SYMBOL_FUNCTION_CALL","expr","'('",
                       "STR_CONST","expr","')'","')'","')'","')'","expr",
                       "SYMBOL","expr","LEFT_ASSIGN","expr","FUNCTION",
                       "'('","SYMBOL_FORMALS","','","SYMBOL_FORMALS","','",
                       "SYMBOL_FORMALS","')'","expr","'{'","expr","SYMBOL",
                       "expr","LEFT_ASSIGN","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","expr","'{'","STR_CONST","expr","'}'",
                       "')'","expr","SYMBOL_FUNCTION_CALL","expr","'('","expr",
                       "'{'","expr","SYMBOL_FUNCTION_CALL","expr","'('",
                       "STR_CONST","expr","','","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","expr","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","SYMBOL","expr","')'","'$'","SYMBOL",
                       "','","SYMBOL_SUB","EQ_SUB","NUM_CONST","expr","')'",
                       "','","SYMBOL_SUB","EQ_SUB","SYMBOL","expr","')'",
                       "expr","SYMBOL_FUNCTION_CALL","expr","'('","')'",
                       "'}'","')'","expr","SYMBOL_FUNCTION_CALL","expr","'('",
                       "expr","SYMBOL","expr","'$'","SYMBOL","','","expr",
                       "'{'","expr","SYMBOL_FUNCTION_CALL","expr","'('",
                       "expr","'{'","STR_CONST","expr","'}'","')'","expr",
                       "SYMBOL_FUNCTION_CALL","expr","'('","expr","'{'",
                       "STR_CONST","expr","'}'","')'","'}'","')'","expr",
                       "expr","SYMBOL_FUNCTION_CALL","expr","'('","expr","'{'",
                       "STR_CONST","expr","'}'","')'","RIGHT_ASSIGN",
                       "SYMBOL","expr","expr","SYMBOL_FUNCTION_CALL","expr",
                       "'('","expr","SYMBOL","expr","'$'","SYMBOL","','",
                       "expr","'{'","expr","expr","SYMBOL","expr","'$'",
                       "SYMBOL","LEFT_ASSIGN","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","expr","'{'","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","')'","STR_CONST","expr","'}'","')'",
                       "'}'","')'","'}'","expr","SYMBOL_FUNCTION_CALL",
                       "expr","'('","SYMBOL","expr","','","SYMBOL","expr",
                       "')'"),
          terminal = c(FALSE,TRUE,FALSE,TRUE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,
                       TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,
                       TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,FALSE,
                       TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,TRUE,TRUE,
                       FALSE,TRUE,TRUE,TRUE,TRUE,FALSE,TRUE,TRUE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,TRUE,TRUE,FALSE,
                       TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,
                       TRUE,TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,
                       TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,FALSE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,
                       TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,TRUE,TRUE,TRUE,
                       TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,
                       TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,
                       TRUE,TRUE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,FALSE,
                       TRUE,FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,TRUE,TRUE,
                       FALSE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,FALSE,
                       TRUE,TRUE,TRUE,TRUE,FALSE,FALSE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,TRUE,TRUE,FALSE,TRUE,
                       FALSE,FALSE,TRUE,FALSE,TRUE,TRUE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,FALSE,TRUE,TRUE,
                       TRUE,FALSE,TRUE,TRUE,TRUE,TRUE,TRUE,FALSE,TRUE,
                       FALSE,TRUE,TRUE,FALSE,TRUE,TRUE,FALSE,TRUE),
              text = c(NA,"library",NA,"(","shiny",
                       NA,")",NA,"foo",NA,"<-",NA,"function","(",")",
                       NA,"{","\"f\"",NA,"}",NA,"ui",NA,"<-",NA,
                       "fluidPage",NA,"(",NA,"fluidRow",NA,"(",NA,"column",
                       NA,"(","2",NA,",",NA,"selectInput",NA,"(",
                       "\"test1\"",NA,",","label","=","\"Test1\"",NA,",",
                       "choices","=","\"\"",NA,")",")",",",NA,"column",NA,
                       "(","2",NA,",",NA,"textOutput",NA,"(","\"test2\"",
                       NA,")",")",")",")",NA,"server",NA,"<-",NA,
                       "function","(","input",",","output",",","session",")",
                       NA,"{",NA,"test3",NA,"<-",NA,"reactive",NA,"(",
                       NA,"{","\"a\"",NA,"}",")",NA,"observe",NA,"(",
                       NA,"{",NA,"assign",NA,"(","\"parse_data\"",NA,",",
                       NA,"getParseData",NA,"(",NA,NA,"environment",NA,
                       "(","server",NA,")","$","server",",","includeText",
                       "=",NA,NA,")",",","envir","=",".GlobalEnv",NA,
                       ")",NA,"test3",NA,"(",")","}",")",NA,
                       "observeEvent",NA,"(",NA,"input",NA,"$","test1",",",NA,"{",
                       NA,"observe",NA,"(",NA,"{","\"c\"",NA,"}",")",
                       NA,"observe",NA,"(",NA,"{","\"d\"",NA,"}",")",
                       "}",")",NA,NA,"reactive",NA,"(",NA,"{","\"e\"",
                       NA,"}",")","->","test4",NA,NA,"eventReactive",NA,
                       "(",NA,"input",NA,"$","test1",",",NA,"{",NA,NA,
                       "output",NA,"$","test2","<-",NA,"renderPrint",NA,
                       "(",NA,"{",NA,"test4",NA,"(",")",
                       "\"Do not nest reactives.\"",NA,"}",")","}",")","}",NA,
                       "shinyApp",NA,"(","ui",NA,",","server",NA,")")
)

path <- system.file("tests_helpers", "server_fun_with_srcref.R", package = "shinybrowser")
# add 'server' function with srcref to environment
source(path, local = TRUE, keep.source = TRUE)
parse_data_srcref <- utils::getParseData(server, includeText = NA)

test_that("'prepare_src_code' returns list if srcref", {
  skip_if_not(interactive())
  e <- new.env(parent = rlang::pkg_env("shinybrowser"))
  expect_type(prepare_src_code(e), "list")
})

test_that("'prepare_src_code' returns NULL if no srcref", {
  env_global_as_parent <- new.env(parent = .GlobalEnv)
  expect_equal(prepare_src_code(env_global_as_parent), NULL)
})

test_that("'find_direct_parent_id_with_reactive' finds only reactives and only top id", {
  expect_equal(find_direct_parent_id_with_reactive(parse_data_str)$id,
                   c(176L, 255L, 326L, 292L, 313L, 352L, 413L, 403L))
})

test_that("'remove_nested_reactives' removes nested reactives", {
  only_reactives <- find_direct_parent_id_with_reactive(parse_data_str)
  expect_equal(remove_nested_reactives(only_reactives)$id,
                   c(176L, 255L, 326L, 352L, 413L))
})

test_that("filename is keep before using 'retrieve_src_code'", {
  find_direct_result <- find_direct_parent_id_with_reactive(parse_data_srcref)
  filename <- attr(find_direct_result, "srcfile")$filename
  expect_equal(filename, attr(attr(server, "srcref"), "srcfile")$filename)

  remove_nested_result <- remove_nested_reactives(find_direct_result)
  filename <- attr(remove_nested_result, "srcfile")$filename
  expect_equal(filename, attr(attr(server, "srcref"), "srcfile")$filename)
})

test_that("'retrieve_src_code' returns data.frame with lines and src code", {
  skip_if_not(interactive())
  expected <- structure(
    list(
      line = c(2L, 3L, 4L, NA, 5L, 6L, 7L, 8L, 9L, NA,
               11L, 12L, 13L, 14L, 15L, 16L, 17L, 18L, 19L, NA, 20L, 21L, 22L,
               NA, 23L, 24L, 25L, 26L, 27L, 28L),
      src_code = c("test3 <- reactive({",
                   "    \"a\"", "  })", NA, "observe({", "    assign(\"parse_data\", getParseData(environment(server)$server, includeText = NA),",
                   "           envir = .GlobalEnv)", "    test3()", "  })", NA,
                   "observeEvent(input$test1, {", "    observe({", "      \"c\"",
                   "    })", "    observe({", "      \"d\"", "    })", "", "  })",
                   NA, "reactive({", "    \"e\"", "  }) -> test4", NA, "eventReactive(input$test1, {",
                   "    output$test2 <- renderPrint({", "      test4()", "      \"Do not nest reactives.\"",
                   "    })", "  })")
      ),
    class = "data.frame",
    row.names = c(NA, -30L)
    )

  only_reactives <- find_direct_parent_id_with_reactive(parse_data_srcref)
  only_reactives_not_nested <- remove_nested_reactives(only_reactives)

  expect_equal(retrieve_src_code(only_reactives_not_nested),
                   expected)
})
